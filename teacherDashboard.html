<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Teacher Dashboard - English 9 Grammar Practice</title>
    <?!= include('styles') ?>
</head>
<body>
    <div class="container">
        <nav class="nav-bar">
            <h2>Teacher Dashboard</h2>
            <div class="nav-links">
                <span id="teacherName">Loading...</span>
                <button class="btn btn-outline" onclick="logout()">Logout</button>
            </div>
        </nav>

        <div class="dashboard">
            <div class="welcome-section">
                <h1>Welcome, Teacher!</h1>
                <p>Monitor student progress and manage assignments</p>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3>Student Progress Overview</h3>
                    <div class="form-group">
                        <label for="studentFilter">Filter by Student:</label>
                        <select id="studentFilter" class="form-control">
                            <option value="">All Students</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="unitFilter">Filter by Unit:</label>
                        <select id="unitFilter" class="form-control">
                            <option value="">All Units</option>
                        </select>
                    </div>

                    <button class="btn btn-primary" onclick="loadStudentProgress()">
                        View Progress
                    </button>
                    <button class="btn btn-outline" onclick="exportProgress()">
                        Export Data
                    </button>
                </div>

                <div class="dashboard-card">
                    <h3>Class Statistics</h3>
                    <div id="statsContainer">
                        <p>Loading class statistics...</p>
                    </div>
                </div>
            </div>

            <div class="progress-section">
                <h3>Student Progress Details</h3>
                <div id="progressTable">
                    <p>Select filters and click "View Progress" to see student data.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Detail Modal -->
    <div id="studentModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="studentModalTitle">Student Details</h3>
                <span class="close" onclick="closeStudentModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="studentDetails">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        let currentTeacher = null;
        let allStudents = [];
        let allProgress = [];

        window.onload = function() {
            initializeTeacherDashboard();
        };

        function initializeTeacherDashboard() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success && result.userType === 'teacher') {
                        // Additional security check for Orono domain
                        if (!result.userEmail.toLowerCase().endsWith('@oronoschools.org')) {
                            alert('Invalid session. Please log in with your Orono Schools email.');
                            window.location.href = '?page=teacherLogin';
                            return;
                        }

                        currentTeacher = result;
                        document.getElementById('teacherName').textContent = result.userEmail;
                        loadStudentList();
                        loadUnits();
                        loadClassStatistics();
                    } else {
                        // Redirect based on user type or invalid session
                        if (result.success && result.userType === 'student') {
                            alert('Students cannot access the teacher interface. Redirecting to student dashboard.');
                            window.location.href = '?page=studentDashboard';
                        } else {
                            window.location.href = '?page=teacherLogin';
                        }
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Session check failed:', error);
                    window.location.href = '?page=teacherLogin';
                })
                .getCurrentUser();
        }

        function loadStudentList() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        allStudents = result.students;
                        populateStudentFilter(result.students);
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Failed to load students:', error);
                })
                .getTeacherStudents();
        }

        function populateStudentFilter(students) {
            const select = document.getElementById('studentFilter');
            select.innerHTML = '<option value="">All Students</option>';

            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.email;
                option.textContent = `${student.firstName} ${student.lastName}`;
                select.appendChild(option);
            });
        }

        function loadUnits() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        const unitSelect = document.getElementById('unitFilter');
                        unitSelect.innerHTML = '<option value="">All Units</option>';

                        result.units.forEach(unit => {
                            const option = document.createElement('option');
                            option.value = unit;
                            option.textContent = 'Unit ' + unit;
                            unitSelect.appendChild(option);
                        });
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Failed to load units:', error);
                })
                .getAvailableUnits();
        }

        function loadClassStatistics() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        displayClassStatistics(result.stats);
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Failed to load class statistics:', error);
                    document.getElementById('statsContainer').innerHTML = '<p class="error">Failed to load statistics</p>';
                })
                .getClassStatistics();
        }

        function displayClassStatistics(stats) {
            const container = document.getElementById('statsContainer');

            let html = '<div class="stats-grid">';
            html += `<div class="stat-item">
                <h4>${stats.totalStudents}</h4>
                <p>Total Students</p>
            </div>`;
            html += `<div class="stat-item">
                <h4>${stats.totalSessions}</h4>
                <p>Practice Sessions</p>
            </div>`;
            html += `<div class="stat-item">
                <h4>${stats.averageScore}%</h4>
                <p>Class Average</p>
            </div>`;
            html += `<div class="stat-item">
                <h4>${stats.activeToday}</h4>
                <p>Active Today</p>
            </div>`;
            html += '</div>';

            if (stats.unitBreakdown && stats.unitBreakdown.length > 0) {
                html += '<h4>Unit Performance</h4>';
                html += '<div class="unit-stats">';
                stats.unitBreakdown.forEach(unit => {
                    html += `<div class="unit-stat">
                        <span>Unit ${unit.unit}</span>
                        <span>${unit.averageScore}% avg (${unit.sessions} sessions)</span>
                    </div>`;
                });
                html += '</div>';
            }

            container.innerHTML = html;
        }

        function loadStudentProgress() {
            const studentEmail = document.getElementById('studentFilter').value;
            const unit = document.getElementById('unitFilter').value;

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        allProgress = result.progress;
                        displayProgressTable(result.progress);
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Failed to load progress:', error);
                    document.getElementById('progressTable').innerHTML = '<p class="error">Failed to load progress data</p>';
                })
                .getFilteredProgress(studentEmail, unit);
        }

        function displayProgressTable(progress) {
            const container = document.getElementById('progressTable');

            if (progress.length === 0) {
                container.innerHTML = '<p>No progress data found for the selected filters.</p>';
                return;
            }

            let html = '<table class="progress-table">';
            html += '<thead><tr>';
            html += '<th>Date</th>';
            html += '<th>Student</th>';
            html += '<th>Unit</th>';
            html += '<th>Score</th>';
            html += '<th>Percentage</th>';
            html += '<th>Actions</th>';
            html += '</tr></thead><tbody>';

            progress.forEach(session => {
                const date = new Date(session.timestamp).toLocaleDateString();
                const percentage = session.percentage;
                const percentageClass = percentage >= 80 ? 'high-score' : percentage >= 60 ? 'medium-score' : 'low-score';

                html += `<tr>
                    <td>${date}</td>
                    <td>${session.studentName}</td>
                    <td>Unit ${session.unit}</td>
                    <td>${session.score}/${session.total}</td>
                    <td class="${percentageClass}">${percentage}%</td>
                    <td>
                        <button class="btn btn-small" onclick="viewStudentDetails('${session.studentEmail}')">
                            View Details
                        </button>
                    </td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function viewStudentDetails(studentEmail) {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        displayStudentDetails(result.progress, studentEmail);
                        document.getElementById('studentModal').style.display = 'block';
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Failed to load student details:', error);
                })
                .getStudentProgress(studentEmail);
        }

        function displayStudentDetails(progress, studentEmail) {
            const student = allStudents.find(s => s.email === studentEmail);
            const studentName = student ? `${student.firstName} ${student.lastName}` : studentEmail;

            document.getElementById('studentModalTitle').textContent = `${studentName} - Progress Details`;

            const container = document.getElementById('studentDetails');

            if (progress.length === 0) {
                container.innerHTML = '<p>No practice sessions found for this student.</p>';
                return;
            }

            // Calculate statistics
            const totalSessions = progress.length;
            const averageScore = Math.round(progress.reduce((sum, p) => sum + p.percentage, 0) / totalSessions);
            const bestScore = Math.max(...progress.map(p => p.percentage));
            const recentSessions = progress.slice(0, 5);

            let html = `
                <div class="student-summary">
                    <h4>Summary Statistics</h4>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <h5>${totalSessions}</h5>
                            <p>Total Sessions</p>
                        </div>
                        <div class="stat-item">
                            <h5>${averageScore}%</h5>
                            <p>Average Score</p>
                        </div>
                        <div class="stat-item">
                            <h5>${bestScore}%</h5>
                            <p>Best Score</p>
                        </div>
                    </div>
                </div>

                <div class="recent-sessions">
                    <h4>Recent Sessions</h4>
                    <table class="progress-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Unit</th>
                                <th>Score</th>
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            recentSessions.forEach(session => {
                const date = new Date(session.timestamp).toLocaleDateString();
                const percentageClass = session.percentage >= 80 ? 'high-score' :
                                      session.percentage >= 60 ? 'medium-score' : 'low-score';

                html += `
                    <tr>
                        <td>${date}</td>
                        <td>Unit ${session.unit}</td>
                        <td>${session.score}/${session.total}</td>
                        <td class="${percentageClass}">${session.percentage}%</td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';

            // Unit breakdown
            const unitStats = {};
            progress.forEach(session => {
                if (!unitStats[session.unit]) {
                    unitStats[session.unit] = { total: 0, count: 0, best: 0 };
                }
                unitStats[session.unit].total += session.percentage;
                unitStats[session.unit].count++;
                unitStats[session.unit].best = Math.max(unitStats[session.unit].best, session.percentage);
            });

            html += '<div class="unit-breakdown"><h4>Performance by Unit</h4>';
            Object.keys(unitStats).forEach(unit => {
                const avg = Math.round(unitStats[unit].total / unitStats[unit].count);
                html += `
                    <div class="unit-performance">
                        <span>Unit ${unit}</span>
                        <span>Avg: ${avg}% | Best: ${unitStats[unit].best}% | Sessions: ${unitStats[unit].count}</span>
                    </div>
                `;
            });
            html += '</div>';

            container.innerHTML = html;
        }

        function closeStudentModal() {
            document.getElementById('studentModal').style.display = 'none';
        }

        function exportProgress() {
            const studentEmail = document.getElementById('studentFilter').value;
            const unit = document.getElementById('unitFilter').value;

            // Create CSV content
            let csv = 'Date,Student Name,Student Email,Unit,Score,Total,Percentage\n';

            allProgress.forEach(session => {
                const date = new Date(session.timestamp).toLocaleDateString();
                csv += `${date},"${session.studentName}",${session.studentEmail},Unit ${session.unit},${session.score},${session.total},${session.percentage}%\n`;
            });

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `student_progress_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function logout() {
            google.script.run
                .withSuccessHandler(function() {
                    window.location.href = '?page=login';
                })
                .withFailureHandler(function(error) {
                    console.error('Logout failed:', error);
                    window.location.href = '?page=login';
                })
                .logout();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('studentModal');
            if (event.target === modal) {
                closeStudentModal();
            }
        }
    </script>
</body>
</html>