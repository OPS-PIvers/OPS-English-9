<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Student Dashboard - English 9 Grammar Practice</title>
    <?!= include('styles') ?>
</head>
<body>
    <div class="container">
        <nav class="nav-bar">
            <h2>English 9 Grammar Practice</h2>
            <div class="nav-links">
                <span id="studentName">Loading...</span>
                <button class="btn btn-outline" onclick="logout()">Logout</button>
            </div>
        </nav>

        <div class="dashboard">
            <div class="welcome-section">
                <h1>Welcome, <span id="welcomeName">Student</span>!</h1>
                <p>Choose a unit to practice grammar exercises</p>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3>Practice Grammar</h3>
                    <p>Select a unit and topic to practice</p>

                    <div class="form-group">
                        <label for="unitSelect">Choose Unit:</label>
                        <select id="unitSelect" class="form-control">
                            <option value="">Loading units...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="topicSelect">Choose Topic (Optional):</label>
                        <select id="topicSelect" class="form-control">
                            <option value="">All topics</option>
                        </select>
                    </div>

                    <button id="startPracticeBtn" class="btn btn-primary" onclick="startPractice()" disabled>
                        Start Practice
                    </button>
                </div>

                <div class="dashboard-card">
                    <h3>Your Progress</h3>
                    <div id="progressContainer">
                        <p>Loading your progress...</p>
                    </div>
                    <button class="btn btn-outline" onclick="viewDetailedProgress()">
                        View Detailed Progress
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div id="progressModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Detailed Progress</h3>
                <span class="close" onclick="closeProgressModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="detailedProgress">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let availableUnits = [];

        // Initialize dashboard on load
        window.onload = function() {
            initializeDashboard();
        };

        function initializeDashboard() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success && result.userType === 'student') {
                        // Additional security check for Orono domain
                        if (!result.userEmail.toLowerCase().endsWith('@oronoschools.org')) {
                            alert('Invalid session. Please log in with your Orono Schools email.');
                            window.location.href = '?page=studentLogin';
                            return;
                        }

                        currentUser = result;
                        document.getElementById('studentName').textContent = result.studentInfo.firstName + ' ' + result.studentInfo.lastName;
                        document.getElementById('welcomeName').textContent = result.studentInfo.firstName;
                        loadUnits();
                        loadProgress();
                    } else {
                        // Redirect based on user type or invalid session
                        if (result.success && result.userType === 'teacher') {
                            alert('Teachers cannot access the student interface. Redirecting to teacher dashboard.');
                            window.location.href = '?page=teacherDashboard';
                        } else {
                            window.location.href = '?page=studentLogin';
                        }
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Session check failed:', error);
                    window.location.href = '?page=studentLogin';
                })
                .getCurrentUser();
        }

        function loadUnits() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        availableUnits = result.units;
                        const unitSelect = document.getElementById('unitSelect');
                        unitSelect.innerHTML = '<option value="">Select a unit</option>';

                        result.units.forEach(unit => {
                            const option = document.createElement('option');
                            option.value = unit;
                            option.textContent = 'Unit ' + unit;
                            unitSelect.appendChild(option);
                        });
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Failed to load units:', error);
                })
                .getAvailableUnits();
        }

        function loadProgress() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        displayProgressSummary(result.progress);
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Failed to load progress:', error);
                    document.getElementById('progressContainer').innerHTML = '<p class="error">Failed to load progress</p>';
                })
                .getStudentProgress();
        }

        function displayProgressSummary(progress) {
            const container = document.getElementById('progressContainer');

            if (progress.length === 0) {
                container.innerHTML = '<p>No practice sessions completed yet. Start practicing to see your progress!</p>';
                return;
            }

            // Calculate summary statistics
            const unitStats = {};
            progress.forEach(session => {
                if (!unitStats[session.unit]) {
                    unitStats[session.unit] = { total: 0, sessions: 0, bestScore: 0 };
                }
                unitStats[session.unit].total += session.percentage;
                unitStats[session.unit].sessions++;
                unitStats[session.unit].bestScore = Math.max(unitStats[session.unit].bestScore, session.percentage);
            });

            let html = '<div class="progress-summary">';
            html += '<h4>Recent Activity</h4>';

            // Show last 3 sessions
            progress.slice(0, 3).forEach(session => {
                html += `<div class="progress-item">
                    <span>Unit ${session.unit}</span>
                    <span>${session.score}/${session.total} (${session.percentage}%)</span>
                </div>`;
            });

            html += '<h4>Unit Averages</h4>';
            Object.keys(unitStats).forEach(unit => {
                const avg = Math.round(unitStats[unit].total / unitStats[unit].sessions);
                html += `<div class="progress-item">
                    <span>Unit ${unit}</span>
                    <span>Avg: ${avg}% (Best: ${unitStats[unit].bestScore}%)</span>
                </div>`;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        document.getElementById('unitSelect').addEventListener('change', function() {
            const selectedUnit = this.value;
            const startBtn = document.getElementById('startPracticeBtn');

            if (selectedUnit) {
                startBtn.disabled = false;
                loadTopicsForUnit(selectedUnit);
            } else {
                startBtn.disabled = true;
                document.getElementById('topicSelect').innerHTML = '<option value="">All topics</option>';
            }
        });

        function loadTopicsForUnit(unit) {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        const topicSelect = document.getElementById('topicSelect');
                        topicSelect.innerHTML = '<option value="">All topics</option>';

                        result.topics.forEach(topic => {
                            const option = document.createElement('option');
                            option.value = topic;
                            option.textContent = topic;
                            topicSelect.appendChild(option);
                        });
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Failed to load topics:', error);
                })
                .getTopicsForUnit(unit);
        }

        function startPractice() {
            const unit = document.getElementById('unitSelect').value;
            const topic = document.getElementById('topicSelect').value;

            if (!unit) {
                alert('Please select a unit first.');
                return;
            }

            const params = new URLSearchParams({
                page: 'grammarPractice',
                unit: unit
            });

            if (topic) {
                params.append('topic', topic);
            }

            window.location.href = '?' + params.toString();
        }

        function viewDetailedProgress() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        displayDetailedProgress(result.progress);
                        document.getElementById('progressModal').style.display = 'block';
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Failed to load detailed progress:', error);
                })
                .getStudentProgress();
        }

        function displayDetailedProgress(progress) {
            const container = document.getElementById('detailedProgress');

            if (progress.length === 0) {
                container.innerHTML = '<p>No practice sessions found.</p>';
                return;
            }

            let html = '<div class="detailed-progress">';
            html += '<table class="progress-table">';
            html += '<thead><tr><th>Date</th><th>Unit</th><th>Score</th><th>Percentage</th></tr></thead>';
            html += '<tbody>';

            progress.forEach(session => {
                const date = new Date(session.timestamp).toLocaleDateString();
                html += `<tr>
                    <td>${date}</td>
                    <td>Unit ${session.unit}</td>
                    <td>${session.score}/${session.total}</td>
                    <td>${session.percentage}%</td>
                </tr>`;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function closeProgressModal() {
            document.getElementById('progressModal').style.display = 'none';
        }

        function logout() {
            google.script.run
                .withSuccessHandler(function() {
                    window.location.href = '?page=login';
                })
                .withFailureHandler(function(error) {
                    console.error('Logout failed:', error);
                    window.location.href = '?page=login';
                })
                .logout();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('progressModal');
            if (event.target === modal) {
                closeProgressModal();
            }
        }
    </script>
</body>
</html>