<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Grammar Practice - English 9</title>
    <?!= include('styles') ?>
</head>
<body>
    <div class="container">
        <nav class="nav-bar">
            <h2>Grammar Practice</h2>
            <div class="nav-links">
                <button class="btn btn-outline" onclick="goToDashboard()">Dashboard</button>
                <button class="btn btn-outline" onclick="logout()">Logout</button>
            </div>
        </nav>

        <div class="practice-container">
            <div class="practice-header">
                <h1 id="practiceTitle">Loading...</h1>
                <div class="practice-info">
                    <span id="questionCounter">Question 0 of 0</span>
                    <span id="scoreDisplay">Score: 0/0</span>
                </div>
            </div>

            <div id="loadingMessage" class="loading-message">
                Loading questions...
            </div>

            <div id="practiceContent" style="display: none;">
                <div class="question-container">
                    <div class="question-header">
                        <span id="questionType" class="question-type"></span>
                        <span id="questionDifficulty" class="difficulty-badge"></span>
                    </div>

                    <div class="question-text">
                        <h3 id="questionText">Question text will appear here</h3>
                    </div>

                    <div id="answerOptions" class="answer-options">
                        <!-- Answer options will be populated here -->
                    </div>

                    <div class="question-actions">
                        <button id="hintBtn" class="btn btn-outline" onclick="showHint()" style="display: none;">
                            Show Hint
                        </button>
                        <button id="submitBtn" class="btn btn-primary" onclick="submitAnswer()" disabled>
                            Submit Answer
                        </button>
                    </div>

                    <div id="hintContainer" class="hint-container" style="display: none;">
                        <p><strong>Hint:</strong> <span id="hintText"></span></p>
                    </div>

                    <div id="feedbackContainer" class="feedback-container" style="display: none;">
                        <!-- Feedback will appear here -->
                    </div>
                </div>

                <div class="practice-controls">
                    <button id="nextBtn" class="btn btn-primary" onclick="nextQuestion()" style="display: none;">
                        Next Question
                    </button>
                    <button id="finishBtn" class="btn btn-success" onclick="finishPractice()" style="display: none;">
                        Finish Practice
                    </button>
                </div>
            </div>

            <div id="resultsContainer" style="display: none;">
                <div class="results-summary">
                    <h2>Practice Complete!</h2>
                    <div class="final-score">
                        <h3 id="finalScore">Your Score: 0/0 (0%)</h3>
                    </div>
                    <div class="results-details" id="resultsDetails">
                        <!-- Results breakdown will appear here -->
                    </div>
                    <div class="results-actions">
                        <button class="btn btn-primary" onclick="goToDashboard()">Back to Dashboard</button>
                        <button class="btn btn-outline" onclick="restartPractice()">Practice Again</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let questions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let selectedAnswers = [];
        let practiceUnit = null;
        let practiceTopic = null;

        window.onload = function() {
            initializePractice();
        };

        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                unit: params.get('unit'),
                topic: params.get('topic')
            };
        }

        function initializePractice() {
            // First validate session
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success && result.userType === 'student') {
                        // Additional security check for Orono domain
                        if (!result.userEmail.toLowerCase().endsWith('@oronoschools.org')) {
                            alert('Invalid session. Please log in with your Orono Schools email.');
                            window.location.href = '?page=studentLogin';
                            return;
                        }

                        const params = getUrlParams();
                        practiceUnit = params.unit;
                        practiceTopic = params.topic;

                        if (!practiceUnit) {
                            alert('No unit specified. Returning to dashboard.');
                            goToDashboard();
                            return;
                        }

                        // Update title
                        let title = `Unit ${practiceUnit} Practice`;
                        if (practiceTopic) {
                            title += ` - ${practiceTopic}`;
                        }
                        document.getElementById('practiceTitle').textContent = title;

                        loadQuestions();
                    } else {
                        // Redirect based on user type or invalid session
                        if (result.success && result.userType === 'teacher') {
                            alert('Teachers cannot access the practice interface. Redirecting to teacher dashboard.');
                            window.location.href = '?page=teacherDashboard';
                        } else {
                            window.location.href = '?page=studentLogin';
                        }
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Session check failed:', error);
                    window.location.href = '?page=studentLogin';
                })
                .getCurrentUser();
        }

        function loadQuestions() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success && result.questions.length > 0) {
                        questions = shuffleArray(result.questions);
                        selectedAnswers = new Array(questions.length);
                        updateQuestionCounter();
                        document.getElementById('loadingMessage').style.display = 'none';
                        document.getElementById('practiceContent').style.display = 'block';
                        showQuestion(0);
                    } else {
                        showError('No questions found for this unit/topic combination.');
                    }
                })
                .withFailureHandler(function(error) {
                    showError('Failed to load questions: ' + error.message);
                })
                .getGrammarQuestions(practiceUnit, practiceTopic);
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function showQuestion(index) {
            if (index >= questions.length) {
                finishPractice();
                return;
            }

            currentQuestionIndex = index;
            const question = questions[index];

            document.getElementById('questionType').textContent = question.questionType;
            document.getElementById('questionDifficulty').textContent = question.difficultyLevel;
            document.getElementById('questionText').textContent = question.question;

            // Show hint button if hint exists
            const hintBtn = document.getElementById('hintBtn');
            if (question.hint && question.hint.trim()) {
                hintBtn.style.display = 'inline-block';
                document.getElementById('hintText').textContent = question.hint;
            } else {
                hintBtn.style.display = 'none';
            }

            // Hide feedback and reset UI
            document.getElementById('feedbackContainer').style.display = 'none';
            document.getElementById('hintContainer').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('finishBtn').style.display = 'none';
            document.getElementById('submitBtn').style.display = 'inline-block';
            document.getElementById('submitBtn').disabled = true;

            showAnswerOptions(question);
            updateQuestionCounter();
        }

        function showAnswerOptions(question) {
            const container = document.getElementById('answerOptions');
            container.innerHTML = '';

            if (question.questionType === 'Multiple Choice') {
                // Collect all answer options
                const options = [question.answer];
                if (question.incorrect1) options.push(question.incorrect1);
                if (question.incorrect2) options.push(question.incorrect2);
                if (question.incorrect3) options.push(question.incorrect3);
                if (question.incorrect4) options.push(question.incorrect4);

                // Shuffle options
                const shuffledOptions = shuffleArray(options);

                shuffledOptions.forEach((option, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'answer-option';
                    optionDiv.innerHTML = `
                        <input type="radio" id="option${index}" name="answer" value="${option}">
                        <label for="option${index}">${option}</label>
                    `;
                    container.appendChild(optionDiv);
                });

                // Add event listeners
                container.querySelectorAll('input[type="radio"]').forEach(radio => {
                    radio.addEventListener('change', function() {
                        document.getElementById('submitBtn').disabled = false;
                    });
                });
            } else {
                // Free text input for other question types
                const inputDiv = document.createElement('div');
                inputDiv.className = 'answer-input';
                inputDiv.innerHTML = `
                    <textarea id="freeTextAnswer" rows="3" placeholder="Enter your answer here..."
                              class="form-control"></textarea>
                `;
                container.appendChild(inputDiv);

                document.getElementById('freeTextAnswer').addEventListener('input', function() {
                    document.getElementById('submitBtn').disabled = this.value.trim() === '';
                });
            }
        }

        function showHint() {
            document.getElementById('hintContainer').style.display = 'block';
        }

        function submitAnswer() {
            const question = questions[currentQuestionIndex];
            let userAnswer = '';

            if (question.questionType === 'Multiple Choice') {
                const selected = document.querySelector('input[name="answer"]:checked');
                userAnswer = selected ? selected.value : '';
            } else {
                userAnswer = document.getElementById('freeTextAnswer').value.trim();
            }

            if (!userAnswer) {
                alert('Please select or enter an answer.');
                return;
            }

            selectedAnswers[currentQuestionIndex] = userAnswer;
            const isCorrect = userAnswer.toLowerCase() === question.answer.toLowerCase();

            if (isCorrect) {
                score++;
            }

            showFeedback(isCorrect, question.answer, userAnswer);
            updateScoreDisplay();

            // Hide submit button, show next/finish button
            document.getElementById('submitBtn').style.display = 'none';
            if (currentQuestionIndex < questions.length - 1) {
                document.getElementById('nextBtn').style.display = 'inline-block';
            } else {
                document.getElementById('finishBtn').style.display = 'inline-block';
            }

            // Disable answer options
            document.querySelectorAll('#answerOptions input').forEach(input => {
                input.disabled = true;
            });
        }

        function showFeedback(isCorrect, correctAnswer, userAnswer) {
            const container = document.getElementById('feedbackContainer');
            container.innerHTML = `
                <div class="feedback ${isCorrect ? 'correct' : 'incorrect'}">
                    <h4>${isCorrect ? 'Correct!' : 'Incorrect'}</h4>
                    ${!isCorrect ? `<p><strong>Correct answer:</strong> ${correctAnswer}</p>` : ''}
                    ${!isCorrect ? `<p><strong>Your answer:</strong> ${userAnswer}</p>` : ''}
                </div>
            `;
            container.style.display = 'block';
        }

        function nextQuestion() {
            showQuestion(currentQuestionIndex + 1);
        }

        function updateQuestionCounter() {
            document.getElementById('questionCounter').textContent =
                `Question ${currentQuestionIndex + 1} of ${questions.length}`;
        }

        function updateScoreDisplay() {
            document.getElementById('scoreDisplay').textContent =
                `Score: ${score}/${questions.length}`;
        }

        function finishPractice() {
            const percentage = Math.round((score / questions.length) * 100);

            // Record score
            google.script.run
                .withSuccessHandler(function(result) {
                    if (!result.success) {
                        console.error('Failed to record score:', result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Error recording score:', error);
                })
                .recordStudentScore(null, practiceUnit, score, questions.length);

            // Show results
            document.getElementById('practiceContent').style.display = 'none';
            document.getElementById('resultsContainer').style.display = 'block';

            document.getElementById('finalScore').textContent =
                `Your Score: ${score}/${questions.length} (${percentage}%)`;

            showResultsBreakdown();
        }

        function showResultsBreakdown() {
            const container = document.getElementById('resultsDetails');
            let html = '<div class="results-breakdown">';

            questions.forEach((question, index) => {
                const userAnswer = selectedAnswers[index] || 'No answer';
                const isCorrect = userAnswer.toLowerCase() === question.answer.toLowerCase();

                html += `
                    <div class="result-item ${isCorrect ? 'correct' : 'incorrect'}">
                        <div class="result-question">${question.question}</div>
                        <div class="result-answers">
                            <span class="correct-answer">Correct: ${question.answer}</span>
                            ${!isCorrect ? `<span class="user-answer">Your answer: ${userAnswer}</span>` : ''}
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function restartPractice() {
            currentQuestionIndex = 0;
            score = 0;
            selectedAnswers = [];
            questions = shuffleArray(questions);
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('practiceContent').style.display = 'block';
            updateScoreDisplay();
            showQuestion(0);
        }

        function goToDashboard() {
            window.location.href = '?page=studentDashboard';
        }

        function logout() {
            google.script.run
                .withSuccessHandler(function() {
                    window.location.href = '?page=login';
                })
                .withFailureHandler(function(error) {
                    console.error('Logout failed:', error);
                    window.location.href = '?page=login';
                })
                .logout();
        }

        function showError(message) {
            document.getElementById('loadingMessage').innerHTML =
                `<div class="error-message">${message}</div>`;
        }
    </script>
</body>
</html>